# 第22章　値の書き変えと参照透過性

## 22.1　参照透過性

一度作ったデータの値が変わらないことを、データが**参照透過性**を持つという。  
データの参照透過性が保たれているプログラムは、可読性が高い。

## 22.2　呼び出し回数のカウント

フィボナッチ数を求める関数`fib`がある。

```
(* フィボナッチ数を求める *)
let rec fib n =
  if n < 2 then n else fib (n - 1) + fib (n - 2)
```

この中で再帰呼び出しが行われているが、それが何回行われたかを調べたいとする。  
そのような場合は、カウンタとして使う値を書き変えるようにすると、プログラムを書きやすい。

## 22.3　参照型と値の書き変え

`ref 初期値`とすることで、変更可能なデータを作れる。変更可能なデータのことを、本書では**セル**と呼ぶ。

```ocaml
# ref 0 ;;
- : int ref = {contents = 0}
```

値にアクセスするには`!セルの名前`とする。

```ocaml
# let hoge = ref 0 ;;
val hoge : int ref = {contents = 0}
# !hoge ;;
- : int = 0
```

値を書き変える代入文は`:=`を使って書く。

```ocaml
# hoge := 4 ;;
- : unit = ()
# !hoge ;;
- : int = 4
```

代入文そのものの値は`()`なので注意。

変更可能なのは値であり、型は初期値を作ったときに決まり変更できない。

```ocaml
# hoge := "4" ;;
Error: This expression has type string but an expression was expected of type
         int
```

`fib`を以下のように書き変えると、`count`というセルに、再帰呼び出しの回数を記録していくことが出来る。

```
(* 再帰の回数を数えるカウンタ *)
let count = ref 0

(* フィボナッチ数を求める *)
let rec fib n =
  (
    count := !count + 1;
    if n < 2 then n else fib (n - 1) + fib (n - 2)
  )
```
